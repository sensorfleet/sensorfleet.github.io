---
layout: post
author: keitsi
og_image: /img/posts/zerologon_blog/og_zerologon.png
description:
  A blog on how to use Suricata IDS on SensorFleet platform to detect Zerologon
  vulnerability
title: Detection of ZeroLogon (CVE-2020-1472) using SensorFleet
excerpt:
  ZeroLogon can be used to exploit a serious vulnerability in Windows Domain
  Controllers. This blog post shows how to detect it using SensorFleet.
---

## Introduction

ZeroLogon can be used to exploit a serious vulnerability in Windows Domain
Controllers.

I was recently asked if you could detect a ZeroLogon attempt using a
SensorFleet-based Sensor. It is easy because we have plug & play support for
Emerging Threats intrusion detection ruleset and
[ZeroLogon was added to the ruleset on September 14th 2020](https://rules.emergingthreats.net/changelogs/suricata-5.0-enhanced.etpro.2020-09-14T23:52:58.txt).

Emerging Threats can be enabled in our [IDS Rule Manager](/instruments/rmgr/)-
and [Suricata IDS](/instruments/suricata/) Instruments.

Here’s how you do it. We’re going to assume that basic Sensor configuration is
already done.

## Step 1: Install Rule Manager and Suricata

There are few easy steps to take if you don’t have
[IDS Rule Manager](/instruments/rmgr/) and
[Suricata IDS](/instruments/suricata/) already enabled:

- Navigate to [SensorFleet Fleet Management](/solution/) UI
- Choose your target Sensor, and choose Add Instrument from the dropdown menu
  <img src="/img/posts/zerologon_blog/01_add_instrument.png" width=500><br>

- Click Add instrument for Suricata and IDS Rule Manager

    <img src="/img/posts/zerologon_blog/02_add_rmgr.png" width=500>

    <img src="/img/posts/zerologon_blog/03_add_suricata.png" width=500>

## Step 2: Configure a capture interface for Suricata

Even if you don’t have it already done, setting up traffic monitoring is a
breeze. It is enough to choose the capture interface since SensorFleet Capture
Engine is usually already configured as part of standard Sensor configuration.

- Locate Suricata IDS from your Fleet Management UI and choose Configure from
  the dropdown menu (it might display an error status due to missing capture
  interface - that’s normal).

    <img src="/img/posts/zerologon_blog/04_configure_suricata.png" width=500>

- Choose Add Interface, select Sensor bridge, type some interface name, only
  choose capability RX and hit Create.

    <img src="/img/posts/zerologon_blog/05_configure_interface.png" width=500>

- Suricata status will change to OK after the configuration:

    <img src="/img/posts/zerologon_blog/06_suricata_ok.png" width=250>

## Step 3: Add Emerging Threats ruleset

Downloader Instrument is enabled as part of standard Sensor configuration and it
gives you a centrally controlled way to fetch external configuration, such as
the Emerging Threats ruleset. You just need to add a new source and the
Downloader will do the heavy lifting.

- Locate IDS Rule Manager Instrument from Fleet Management UI and click the UI
  button

    <img src="/img/posts/zerologon_blog/07_rmgr_ui.png" width=500>

* Click Add rulesource

    <img src="/img/posts/zerologon_blog/08_add_rulesource.png" width=500>

- Type settings for the rulesource:

  ```
  Name: Emerging Threats
  URL: https://rules.emergingthreats.net/open/suricata-5.0/emerging.rules.tar.gz
  Source type: External
  Import Interval: 3600
  [X] Enabled
  ```

  With these settings, the URL will be checked for updates with HTTP HEAD every
  3600 seconds, and downloaded only when file changes.

    <img src="/img/posts/zerologon_blog/09_add_rulesource_2.png" width=500 title="adding a rule source to Rule Manager Instrument">

- After a while, you will see the Emerging Threats rules in Rule Manager UI.

    <img src="/img/posts/zerologon_blog/10_etrules.png" width=500 title="Rule Manager Instrument rule tree view">

* Just in case, you can search the ruleset to find the ZeroLogon Rule. Open Rule
  search and type _zerologon_ to show the zerologon rules.

    <img src="/img/posts/zerologon_blog/11_search.png" width=500 title="sample rules from Emerging Threats">

## Step 4: Testing the rule

It is always a good idea to test your ruleset.

Right now, the easiest way to test it against ZeroLogon detection would be to
replay a traffic capture (pcap) that should trigger the alert. Luckily
[there is a pcap that does just this](https://github.com/corelight/zerologon/blob/master/testing/Traces/CVE-2020-1472_exploit_win2019.pcap).

There is another way -
[launch a live attack against your Windows Domain Controller](https://github.com/dirkjanm/CVE-2020-1472).
I wouldn’t try that in production though.

We’re going to try the pcap. This assumes you only have a single bridge in your
setup.

- Login to your sensor using SSH.
- List active bridges:

  ```
  fleet config show <sensor_id>
  ```

- Install tcpreplay utility:

  ```
  sudo apt update && sudo apt install tcpreplay
  ```

- Grant permissions to write to the bridge interface from host.
  ```
  cat > /etc/ferm/ferm.d/99-allow-br0-hostbridge.conf <<EOF
  domain eb chain INPUT logical-in br0 ACCEPT;
  domain eb chain OUTPUT logical-out br0 ACCEPT;
  EOF
  service ferm reload
  ```

* Download the test pcap to your sensor.
  ```
  curl \
      https://github.com/corelight/zerologon/blob/master/testing/Traces/CVE-2020-1472_exploit_win2019.pcap \
      -o /root/zerologon.pcap
  ```

- The exploit in pcap uses the IP addresses _172.16.0.10_ and _172.16.5.58_.
  Those should be included in your Sensor’s homenets. Add _172.16.0.0/21_ to
  your Sensor homenets: Choose configure from the Sensor dropdown menu, open
  Settings tab, add home network _172.16.0.0/21_ and Save.

    <img src="/img/posts/zerologon_blog/12_network.png" width=500 title="adding a network">

* Replay the pcap file to your bridge interface

  ```
  tcpreplay-edit -i br0 /root/zerologon.pcap
  ```

* Open Suricata IDS events page. You should see events like these:

    <img src="/img/posts/zerologon_blog/13_events.png" width=500 title="events view from UI">

    <img src="/img/posts/zerologon_blog/14_event.png" width=500 title="sample event">
    ```
    Event message: Suricata alert 172.16.0.10 -> 172.16.5.58: ET EXPLOIT Possible Zerologon NetrServerAuthenticate with 0x00 Client Credentials (CVE-2020-1472)
    ```

## Final words

Running Suricata in your network can be very useful. With good quality free
rules like Emerging Threats, you can catch a lot of badness in your network
before things get out of control. If you see such an event, there might be still
time to shutdown or disconnect the servers and create last minute snapshots of
the data before the attacker installs a cryptolocker software or some other
means to disrupt your business.
